# Course 06 学习笔记（Building Trustworthy Agents）

- 日期：2026-01-21
- 学习时长：30min

## 课程目标与核心收获
- 理解“可信 AI 代理”（Trustworthy AI Agents）的概念与构建要点：系统提示设计、风险识别、权限与访问控制、数据沿袭与审计（audit trail）、以及结合人类参与（human‑in‑the‑loop）来降低风险。 
- 掌握在代理设计中降低威胁的常见方法：输入验证/提示过滤、最小权限原则、请求限流、隔离执行环境（sandboxing/containerization）和知识库完整性检查（防止数据投毒）。
- 学会把可解释性（explainability）与可审计性（auditability）作为设计一部分，以便在出现问题时能追溯决策链路并提供可检验证据。

## 关键术语与模式（英文保留并解释）
- System Message / System Prompt：设置代理元规则与行为准则的“系统级”提示，用于限定代理权限、语气与处理边界。
- Human‑in‑the‑Loop（HITL）：在关键步骤引入人工审批或确认，常用于高风险或需要合规审查的场景。
- Principle of Least Privilege（最小权限原则）：代理应只在完成任务所需的最小权限范围内访问资源或系统接口。
- Audit Trail / Data Lineage：记录输入、检索的证据、模型生成与工具调用等操作的日志，用于事后溯源与合规审计。
- Prompt Injection / Instruction Tampering：攻击者通过外部输入改变或注入提示，误导代理执行非预期操作；需用输入过滤与提示边界策略缓解。
- Knowledge Base Poisoning（知识库投毒）：恶意或错误数据进入知识库导致代理产生偏差或不实结论；缓解策略包括数据来源验证、版本控制与定期审查。
- Explainability / Attribution：在回答中显示所依据的来源或检索片段，提升可信度并便于用户核验。

## 示例与实践要点
- 系统消息框架（meta‑system prompt）：用一条“元提示”模板生成各个角色/代理的系统消息，便于规模化与一致性管理（示例见课程资料中的元提示→基础提示→合成系统提示流程）。
- 权限与隔离：把外部工具（数据库、API、敏感系统）封装为受控工具（Tool/Plugin），并施加权限校验、速率限制与审计日志。对高风险操作要求人工审批（HITL）。
- 人类参与模式：可采用 `UserProxyAgent` 等代理将控制权交给真实用户/审阅者（示例代码使用 `TextMentionTermination("APPROVE")` 作为结束信号），常见流程为自动建议→人工审阅→批准或拒绝。
- 数据与知识库治理：对入库文档进行来源校验、签名或白名单管理；对可编辑知识库实施变更审核与版本回滚机制。
- 可解释性实践：在生成回复时同时返回检索来源、引用片段与短摘要，必要时提供决策链（what→why→evidence）。

## 易错点与排查
- 依赖外部输入直接拼接到 system/user prompt：可能导致提示注入，应对用户/外部数据进行白名单/正则/结构化校验与转义处理。
- 日志不完整或被覆盖：确保 audit trail 包含原始输入、检索证据（source ids/offsets）、tool calls 与最终生成文本；避免只记录“最终答案”导致无法追溯。
- 人工参与延迟与阻塞：HITL 改善安全但可能成为瓶颈；为关键路径与非关键路径设计不同审批策略（异步审批/委托机制）。
- 权限配置过宽或过细：过宽会导致泄露，过细可能阻塞正常功能；建议基于角色划分并按场景做回归测试。
- 知识库污染未检测：定期运行数据完整性检测（duplicate detection、outlier detection）并对高风险来源设置更严格的准入门槛。

## 参考与下一步
- 课程资料示例（human‑in‑the‑loop 与系统消息框架）：课程资源中的示例代码和流程图，可在项目文档中查阅。
- 推荐练习：
  - 在本地实现一个小型 HITL 流程：自动生成建议 → 通过 `UserProxyAgent` 或模拟审批者进行人工确认 → 在批准后执行敏感工具调用。
  - 为现有 RAG Agent 增加审计日志：记录每次检索的 `source_id`、使用的 prompt 模板与最终模型输出，评估可审计性。 

## 下节课预习（Planning Design）
- 主题：规划/执行（Planner / Executor）设计模式，如何把复杂任务拆解为子任务并由执行器逐步完成与验证。
- 关键术语：Planner、Executor、Reflection、Retry、Stop Conditions。
- 练习建议：设计一个 planner，把用户请求分解为多个可执行步骤并在每步加入失败回退策略。
