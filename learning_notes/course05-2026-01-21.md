# Course 05 学习笔记（Agentic RAG）

- 日期：2026-01-21
- 学习时长：60min

## 课程目标与核心收获
- 理解 RAG（Retrieval‑Augmented Generation）的整体流程：文档分片（chunking）→ 向量化（embeddings）→ 存入向量数据库（vector DB）→ 检索（retriever）→ 上下文融合（prompt composition）→ 生成。
- 掌握关键组件与取舍：embeddings 模型选择、chunk 大小、检索策略（BM25 vs vector）、top‑k 与 rerank、以及如何将检索结果安全地注入到模型上下文中以减少幻觉（hallucination）。
- 会使用 RAG 与 Agent 结合的常见模式（检索作为工具/记忆层），并了解如何在 Agent 流程中实现检索→工具调用→融合回答的闭环。

## 关键术语与模式（英文保留并解释）
- RAG（Retrieval‑Augmented Generation）：将检索到的外部知识作为上下文，增强生成模型的事实性与覆盖面。
- Embeddings：把文本映射到向量空间的函数；选择模型时需平衡语义质量与速度/成本（例如 text‑embedding‑3 vs 小型本地模型）。
- Vector DB：用于存储与检索向量（例如 Chroma、FAISS、Milvus、Pinecone）；支持近邻搜索（ANN）与元数据过滤（metadata filtering）。
- Chunking（Chunking / Chunk size）：将长文档切分为小段；常见做法是按语义/句子边界并限制 token 数，使检索结果与上下文窗口匹配。
- Retriever（Retriever / Retriever Pipeline）：负责从向量库中返回最相关的候选段；可结合稠密检索（vector）与稀疏检索（BM25）做混合检索。
- Reranker：对初步候选进行二次排序（可用小模型或交叉编码器）以提高精确性。
- Grounding（Grounding / Attribution）：在生成中引用/标注检索来源，减少模型无凭据输出并方便用户验证。
- Context Window / Token Budget：在将检索片段注入 prompt 时，必须控制 token 总量（system+retrieved+user）以免超限。

## 示例与实践要点
- 构建流程（推荐顺序）：
  - 文档预处理：清洗、去重、按语义/段落分片并保留来源元数据（source id / url / doc id / offset）。
  - 生成 embeddings：选择合适模型批量计算 embeddings，注意批处理与速率限制。
  - 插入向量库：保存向量与元数据；对长期存储进行定期去重与压缩（例如合并相似短片段）。
  - 检索策略：默认 top‑k（k=5–10），在需要高精度时加入 reranker 或二阶段检索（dense→cross‑encoder）。
  - Prompt 设计：限制每个片段 token，按相关性裁剪并加入明确的指令（e.g., "Use the following sources to answer and cite them if used.")。
  - Agents 集成：把 retriever 封装成工具（Tool/Plugin），让 Agent 在需要时调用并把检索内容以 role="tool" 的消息回传给模型用于最终生成。

- 常见优化：
  - 使用滑动窗口或重叠 chunk 保留上下文连续性。
  - 对高频查询建立缓存（query→top results）减少昂贵检索。
  - 对专用知识库训练或微调小型 reranker 提升域内表现。
  - 利用 metadata filter（time, source, author）进行上下文限制，避免过时或不相关信息。

## 易错点与排查
- 源未保存/丢失偏移：插入向量库时务必保存 `source_id` 与位置（offset），以便生成时引用正确位置。
- chunk 太大导致超出 token：在 prompt 组装前计算 token，必要时裁剪或只保留摘要/高相关部分。
- embeddings 不一致：使用统一的 embeddings 模型与文本规范化流程（小写化/去空白/normalize unicode），否则相似度会失真。
- 忽略 rerank：仅靠原始 ANN 返回的向量距离，有时会带来语义噪音；遇到精度问题请加入交叉编码 reranker。
- 注入未消毒的用户内容：在把用户输入与检索结果拼接给模型前，避免把未核验的外部内容直接作为指令的一部分（防止提示注入）。
- 权重误配：在混合检索（BM25 + dense）时注意归一化分数与融合策略，避免某一方过度主导。

## 参考与下一步
- 代码示例（练习位置）：
  - `05-agentic-rag/README.md`（课件与样例指引）
  - 尝试把 retriever 封装为 `Tool`：在 Agent 框架中注册检索工具并按需调用。
- 下一步练习建议：
  - 完整实现一个 RAG Agent：文档入库 → simple retriever tool → Agent 调用并生成带引用的答案。
  - 对比不同 embeddings 与 vector DB 的检索质量与延迟（metrics: recall@k, latency）。

## 下节课预习（Building Trustworthy Agents）
- 主题：可信 AI Agent：偏差/公正性、隐私合规、可解释性、审计与安全边界。
- 关键术语：Explainability、Data Lineage、Access Control、Audit Trail、Differential Privacy。
- 练习建议：检查 RAG Agent 的数据沿袭（source tracing），并为敏感数据添加访问控制与删除流程。
