# Course 07 学习笔记（Planning Design）

- 日期：2026-01-22
- 学习时长：30min

## 课程目标与核心收获
- 掌握规划与设计模式的核心概念：将复杂任务分解为可管理的子任务，通过层次化、顺序化或并行化方式执行，并实现自适应规划与进度监控。
- 理解规划架构的关键组件：任务分解（Task Decomposition）、执行规划（Execution Planning）、资源管理（Resource Management）与进度监控（Progress Monitoring）。
- 学会应用设计模式到代理开发：策略模式（Strategy Pattern）用于多场景规划、责任链模式（Chain of Responsibility）提供备用选项、命令模式（Command Pattern）支持撤销重做、观察者模式（Observer Pattern）实现事件驱动更新。
- 掌握规划方法论：层次化任务规划（Hierarchical Task Planning）、顺序规划（Sequential Planning）、并行规划（Parallel Planning），并结合 SMART 目标、资源感知与错误弹性设计。

## 关键术语与模式（英文保留并解释）
- Task Decomposition（任务分解）：将复杂目标拆分为更小、更易管理的子任务，形成层次结构便于执行与监控。
- Execution Planning（执行规划）：确定子任务的最佳执行顺序、依赖关系与资源分配，确保高效完成。
- Resource Management（资源管理）：在可用资源（如 API 配额、计算能力）内优化任务分配，避免瓶颈与冲突。
- Progress Monitoring（进度监控）：持续跟踪任务完成情况，根据反馈动态调整规划策略。
- Strategy Pattern（策略模式）：为不同场景提供多种规划算法，支持运行时切换（如从保守规划切换到激进规划）。
- Chain of Responsibility（责任链模式）：顺序处理请求并提供备用方案，当一个规划器失败时自动切换到下一个。
- Command Pattern（命令模式）：将任务执行封装为命令对象，支持撤销（undo）、重做（redo）与队列管理。
- Observer Pattern（观察者模式）：通过事件驱动机制实现进度通知与状态更新，便于多组件协作。
- Hierarchical Task Planning（层次化任务规划）：自上而下分解目标，创建带有依赖关系的嵌套任务结构。
- Sequential Planning（顺序规划）：按固定步骤执行任务，包含错误处理、检查点与回滚机制。
- Parallel Planning（并行规划）：并发执行独立任务，通过同步机制协调完成与结果汇总。
- Meta-Planning（元规划）：代理具备规划自身规划过程的能力，实现更高层次的智能。
- Adaptive Planning（自适应规划）：根据执行反馈、环境变化或新信息动态重新规划。

## 示例与实践要点
- 规划系统架构：使用 Microsoft Agent Framework 创建规划代理，结合 GitHub Models 进行推理与决策。
- Pydantic 模型定义：创建结构化输出模型如 `TravelPlan` 和 `SubTask`，确保响应格式化与可解析。
- 异步执行：使用 `asyncio.run()` 包装异步 `agent.run()` 调用，在 Jupyter Notebook 环境中正确执行。
- 消息构造：使用 `ChatMessage` 创建结构化对话，指定角色（Role.USER/ASSISTANT）与内容。
- 客户端配置：通过 `OpenAIChatClient` 连接 GitHub Models，设置 endpoint、token 与模型 ID。
- 代理创建：使用 `ChatAgent(chat_client=client, instructions=instructions)` 初始化规划代理。
- 响应处理：解析结构化响应，提取 `main_task` 与 `subtasks` 列表进行后续处理。

## 易错点与排查
- API 版本不匹配：`OpenAIChatClient` 无 `create_agent` 方法，应使用 `ChatAgent` 类；导入时需包含 `ChatAgent`。
- 异步调用错误：在不支持顶层 `await` 的环境中直接使用 `await` 会报 SyntaxError；应使用 `asyncio.run()` 包装。
- 环境变量缺失：未设置 `GITHUB_TOKEN`、`GITHUB_ENDPOINT`、`GITHUB_MODEL_ID` 会导致认证失败；运行前确保 `load_dotenv()` 已调用。
- 响应格式不生效：`response_format=TravelPlan` 可能不直接产生 JSON 结构；检查模型是否支持结构化输出，或手动解析文本响应。
- 导入错误：缺少必要的导入如 `from agent_framework import ChatAgent` 会导致 NameError；确保所有依赖正确安装。
- 内核状态不一致：修改代码后未重新运行前序单元格，导致变量未定义；建议按顺序执行所有单元格。

## 参考与下一步
- 课程资料示例：Microsoft Agent Framework 官方文档与 GitHub Models 集成指南。
- 推荐练习：
  - 实现一个简单的旅行规划代理：定义 Pydantic 模型，创建 ChatAgent，处理用户查询并返回结构化规划。
  - 扩展规划逻辑：为代理添加多步骤验证、错误重试与进度跟踪功能。
  - 对比不同框架：在同一场景下尝试 AutoGen 或 Semantic Kernel 的规划实现，对比优缺点。

## 下节课预习（Multi-Agent）
- 主题：多代理系统设计与协作，如何协调多个专门化代理完成复杂任务，实现代理间的通信、任务分配与冲突解决。
- 关键术语：Multi-Agent Systems、Agent Communication、Task Allocation、Conflict Resolution、Coordination Protocols。
- 练习建议：设计一个多代理系统处理客户服务场景，包括接待代理、订单代理与投诉代理，实现代理间的手动与消息传递。